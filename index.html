<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Présence - Élève</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 20px;
      max-width: 520px;
      margin: 0 auto;
      background: #f5f5f5;
      transition: background-color 0.2s ease;
    }
    body.ok-bg { background: #dcfce7; }
    body.ko-bg { background: #fee2e2; }
    h1 {
      font-size: 1.4rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    h1 small {
      font-size: 0.9rem;
      font-weight: 400;
      color: #555;
    }
    .card {
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    select, input {
      width: 100%;
      padding: 8px 10px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
      box-sizing: border-box;
    }
    button {
      margin-top: 16px;
      width: 100%;
      padding: 10px;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: #2563eb;
      color: white;
    }
    button:active {
      transform: scale(0.98);
    }
    .result {
      margin-top: 16px;
      font-size: 1.1rem;
      font-weight: 700;
      text-align: center;
      padding: 10px;
      border-radius: 10px;
    }
    .ok {
      color: #166534;
      background: #bbf7d0;
    }
    .ko {
      color: #991b1b;
      background: #fecaca;
    }
    .hint {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #555;
      text-align: center;
    }
    .creneau-locked-badge {
      display: inline-block;
      margin-left: 8px;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
    }
    .error-msg {
      font-size: 0.8rem;
      color: #b91c1c;
      margin-top: 4px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Pointage de présence<br><small>Mode élève</small></h1>
  <div class="card">
    <label id="labelCreneau" for="creneau">Créneau</label>
    <!-- options remplies dynamiquement depuis Firestore -->
    <select id="creneau">
      <option value="" disabled selected>Chargement des créneaux...</option>
    </select>

    <label for="nom">Nom et prénom</label>
    <input id="nom" type="text" placeholder="Commence à taper ton nom..." list="listeNoms" autocomplete="off">
    <datalist id="listeNoms"></datalist>

    <button id="valider">Valider</button>

    <div id="result" class="result" style="display:none;"></div>
    <div id="fbError" class="error-msg" style="display:none;"></div>
    <div class="hint">
      1. Scanne le QR code<br>
      2. Vérifie que le créneau est correct<br>
      3. Tape ou choisis ton nom dans la liste<br>
      4. Le bip confirme ta présence (aigu = OK, grave = erreur)
    </div>
  </div>

  <!-- Firebase (CDN compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // ====== Config Firebase ======
    const firebaseConfig = {
      apiKey: "AIzaSyBCi4rQd43QsxPektjewCC5Ym83jHMWddA",
      authDomain: "app-epf-377c3.firebaseapp.com",
      projectId: "app-epf-377c3",
      storageBucket: "app-epf-377c3.firebasestorage.app",
      messagingSenderId: "790462947678",
      appId: "1:790462947678:web:c4755c8e410596120aefcf",
      measurementId: "G-3FKJK8PVZ0"
    };

    let db = null;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
    } catch (e) {
      console.error("Erreur Firebase:", e);
    }

    // ====== Variables globales pour les listes dynamiques ======
    let LISTES = {};          // { "Créneau": ["Nom Prénom", ...], ... }
    let ALIAS_CRENEAU = {};   // { "14H": "Passage à partir de 14H", ... }
    let listesChargees = false;

    // ====== Normalisation des noms ======
    function normalizeName(str) {
      return str
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z\s]/g, "")
        .trim()
        .replace(/\s+/g, " ");
    }

    function isInList(list, name) {
      const target = normalizeName(name);
      for (const item of list) {
        if (normalizeName(item) === target) {
          return true;
        }
      }
      return false;
    }

    // ====== Sons local (élève) ======
    function playBeep(isOk) {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if (!AudioCtx) return;
      const ctx = new AudioCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "sine";

      if (isOk) {
        osc.frequency.setValueAtTime(1200, ctx.currentTime);
        gain.gain.setValueAtTime(0.16, ctx.currentTime);
        osc.frequency.linearRampToValueAtTime(1500, ctx.currentTime + 0.15);
        osc.start();
        osc.stop(ctx.currentTime + 0.18);
      } else {
        osc.frequency.setValueAtTime(400, ctx.currentTime);
        gain.gain.setValueAtTime(0.2, ctx.currentTime);
        osc.frequency.linearRampToValueAtTime(300, ctx.currentTime + 0.4);
        osc.start();
        osc.stop(ctx.currentTime + 0.45);
      }

      osc.connect(gain);
      gain.connect(ctx.destination);
    }

    // ====== UI / éléments ======
    const selectCreneau = document.getElementById("creneau");
    const inputNom = document.getElementById("nom");
    const dataList = document.getElementById("listeNoms");
    const btnValider = document.getElementById("valider");
    const divResult = document.getElementById("result");
    const labelCreneau = document.getElementById("labelCreneau");
    const fbError = document.getElementById("fbError");

    // On bloque la validation tant que les listes ne sont pas chargées
    btnValider.disabled = true;
    selectCreneau.disabled = true;

    function updateNameList() {
      const creneau = selectCreneau.value;
      const liste = LISTES[creneau] || [];
      dataList.innerHTML = "";
      liste.forEach(nom => {
        const opt = document.createElement("option");
        opt.value = nom;
        dataList.appendChild(opt);
      });
      inputNom.value = "";
      divResult.style.display = "none";
      document.body.classList.remove("ok-bg", "ko-bg");
    }

    selectCreneau.addEventListener("change", updateNameList);

    function construireAlias() {
      const alias = {};
      Object.keys(LISTES).forEach(sheetName => {
        let short = "";
        sheetName.split(" ").forEach(token => {
          if (/[0-9]/.test(token) && !short) {
            short = token;
          }
        });
        alias[short || sheetName] = sheetName;
      });
      ALIAS_CRENEAU = alias;
    }

    async function chargerListesDepuisFirestore() {
      if (!db) {
        fbError.style.display = "block";
        fbError.textContent = "Erreur : Firebase non configuré.";
        return;
      }
      try {
        const snap = await db.collection("listesEleves").get();
        if (snap.empty) {
          fbError.style.display = "block";
          fbError.textContent = "Aucune liste d'élèves trouvée dans Firestore.";
          return;
        }

        LISTES = {};
        snap.forEach(doc => {
          const data = doc.data();
          LISTES[doc.id] = data.eleves || [];
        });

        construireAlias();

        // Remplir le select des créneaux
        selectCreneau.innerHTML = "";
        Object.keys(LISTES).forEach(creneau => {
          const opt = document.createElement("option");
          opt.value = creneau;
          opt.textContent = creneau;
          selectCreneau.appendChild(opt);
        });

        // Gestion du ?creneau= dans l'URL (verrouillage QR code)
        const params = new URLSearchParams(window.location.search);
        let c = params.get("creneau");
        if (c) {
          if (!LISTES[c] && ALIAS_CRENEAU[c]) {
            c = ALIAS_CRENEAU[c];
          }
          if (LISTES[c]) {
            selectCreneau.value = c;
            selectCreneau.disabled = true;
            const badge = document.createElement("span");
            badge.className = "creneau-locked-badge";
            badge.textContent = "verrouillé par le QR code";
            labelCreneau.appendChild(badge);
          }
        }

        listesChargees = true;
        selectCreneau.disabled = false;
        btnValider.disabled = false;
        fbError.style.display = "none";
        updateNameList();
      } catch (e) {
        console.error(e);
        fbError.style.display = "block";
        fbError.textContent = "Erreur lors du chargement des listes d'élèves.";
      }
    }

    // ====== Envoi Firestore (pour l'écran employé) ======
    async function sendToFirestore(data) {
      if (!db) {
        fbError.style.display = "block";
        fbError.textContent = "Présence non synchronisée (Firebase non configuré).";
        return;
      }
      fbError.style.display = "none";
      try {
        await db.collection("presences").add(Object.assign(data, {
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }));
      } catch (e) {
        console.error("Erreur enregistrement présence:", e);
        fbError.style.display = "block";
        fbError.textContent = "Erreur de synchronisation, mais ta présence locale est validée.";
      }
    }

    // ====== Validation ======
    btnValider.addEventListener("click", async () => {
      if (!listesChargees) return;

      const creneau = selectCreneau.value;
      const nom = inputNom.value;

      document.body.classList.remove("ok-bg", "ko-bg");

      if (!nom.trim()) {
        divResult.style.display = "block";
        divResult.textContent = "Merci de saisir ou choisir ton nom et prénom.";
        divResult.className = "result ko";
        playBeep(false);
        document.body.classList.add("ko-bg");
        return;
      }

      const liste = LISTES[creneau] || [];
      const present = isInList(liste, nom);

      if (present) {
        divResult.style.display = "block";
        divResult.textContent = "Présence validée ✅";
        divResult.className = "result ok";
        playBeep(true);
        document.body.classList.add("ok-bg");
      } else {
        divResult.style.display = "block";
        divResult.textContent = "Nom non trouvé dans la liste ❌";
        divResult.className = "result ko";
        playBeep(false);
        document.body.classList.add("ko-bg");
      }

      // Envoi asynchrone vers Firestore
      sendToFirestore({
        nom: nom,
        creneau: creneau,
        present: present
      });

      inputNom.focus();
      inputNom.select();
    });

    inputNom.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        btnValider.click();
      }
    });

    // Charger les listes au démarrage
    chargerListesDepuisFirestore();
  </script>
</body>
</html>
